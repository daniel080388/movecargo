<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MoveCargo - Marketplace de Transporte</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
</head>
<body class="bg-gray-100">
  <!-- Header -->
  <header class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">MoveCargo</h1>
    <button id="loginBtn" class="bg-white text-blue-600 px-4 py-2 rounded">Entrar / Registar</button>
	<a id="loginBtn" href="#" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">Entrar</a>
    <a id="registerBtn" href="#" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium ml-2">Registar</a>

  </header>

  <!-- Container -->
  <main class="p-6">
    <!-- Publicar carga -->
    <section class="mb-6 bg-white p-4 shadow rounded">
      <h2 class="text-lg font-semibold mb-2">Publicar Nova Carga</h2>
      <form id="formCarga" class="grid grid-cols-2 gap-4">
        <input type="text" id="origem" placeholder="Origem (cidade, país)" class="border p-2 rounded" required>
        <input type="text" id="destino" placeholder="Destino (cidade, país)" class="border p-2 rounded" required>
        <select id="tipoCaminhao" class="border p-2 rounded">
          <option value="frigorífico">Frigorífico</option>
          <option value="aberto">Aberto</option>
          <option value="lona">Lona</option>
          <option value="cisterna">Cisterna</option>
        </select>
        <input type="number" id="peso" placeholder="Peso (ton)" class="border p-2 rounded" required>
        <input type="date" id="dataCarregamento" class="border p-2 rounded" required>
        <select id="pagamento" class="border p-2 rounded">
          <option value="imediato">Imediato</option>
          <option value="30d">30 dias</option>
          <option value="60d">60 dias</option>
          <option value="90d">90 dias</option>
        </select>
        <button type="submit" class="col-span-2 bg-blue-600 text-white py-2 rounded">Publicar</button>
      </form>
    </section>

    <!-- Mapa -->
    <section class="mb-6 bg-white p-4 shadow rounded">
      <h2 class="text-lg font-semibold mb-2">Mapa de Cargas</h2>
      <div id="map" class="h-96 w-full rounded"></div>
    </section>

    <!-- Tabela -->
    <section class="bg-white p-4 shadow rounded">
      <h2 class="text-lg font-semibold mb-2">Lista de Cargas</h2>
      <table class="min-w-full divide-y divide-gray-200">
        <thead>
          <tr class="bg-gray-100">
            <th class="px-4 py-2 text-left">Origem</th>
            <th class="px-4 py-2 text-left">Destino</th>
            <th class="px-4 py-2 text-left">Camião</th>
            <th class="px-4 py-2 text-left">Peso</th>
            <th class="px-4 py-2 text-left">Data</th>
            <th class="px-4 py-2 text-left">Pagamento</th>
            <th class="px-4 py-2 text-left">Ações</th>
          </tr>
        </thead>
        <tbody id="tabelaCargas" class="divide-y divide-gray-200"></tbody>
      </table>
    </section>
  </main>

  <!-- Scripts -->
  <script>
  let token = localStorage.getItem("token") || null;
  let role = localStorage.getItem("role") || null;
  let userName = localStorage.getItem("name") || null;

  document.getElementById("loginBtn").addEventListener("click", async () => {
    const email = prompt("Email:");
    const senha = prompt("Senha:");

    try {
      const response = await fetch("http://localhost:3000/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password: senha }) // <-- sua API espera "password"
      });

      if (response.ok) {
        const data = await response.json();

        // Salva no localStorage
        token = data.token;
        role = data.role;
        userName = data.name;

        localStorage.setItem("token", token);
        localStorage.setItem("role", role);
        localStorage.setItem("name", userName);

        alert(`Bem-vindo, ${userName}!`);
      } else {
        const erro = await response.json();
        alert("Erro no login: " + erro.error);
      }
    } catch (err) {
      console.error("Erro ao conectar:", err);
      alert("Erro ao conectar com servidor.");
    }
  });
  <script>
  document.getElementById("registerBtn").addEventListener("click", async () => {
    const name = prompt("Nome completo:");
    const email = prompt("Email:");
    const password = prompt("Senha:");
    const role = prompt("Papel (ex: shipper ou carrier):"); // empresa que publica carga ou transportadora

    if (!name || !email || !password || !role) {
      alert("⚠️ Todos os campos são obrigatórios!");
      return;
    }

    try {
      const response = await fetch("http://localhost:3000/api/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, email, password, role }),
      });

      if (response.ok) {
        const data = await response.json();
        alert("✅ Registro efetuado com sucesso!");
        console.log("Novo usuário:", data.user);
      } else {
        const erro = await response.json();
        alert("❌ Erro no registro: " + erro.error);
      }
    } catch (err) {
      console.error("Erro ao conectar:", err);
      alert("❌ Erro ao conectar com servidor.");
    }
  });

    // === Carregar cargas ===
    async function carregarCargas() {
      const response = await fetch("https://suaapi.com/cargas");
      const cargas = await response.json();
      atualizarMapa(cargas);
      atualizarTabela(cargas);
    }

    function atualizarMapa(cargas) {
      cargas.forEach(carga => {
        const el = document.createElement("div");
        el.className = carga.disponivel ? "bg-green-500 w-4 h-4 rounded-full" : "bg-red-500 w-4 h-4 rounded-full";

        new mapboxgl.Marker(el)
          .setLngLat([carga.origem.lng, carga.origem.lat])
          .setPopup(new mapboxgl.Popup().setHTML(
            `<strong>${carga.origem.cidade} → ${carga.destino.cidade}</strong><br>Peso: ${carga.peso} ton`
          ))
          .addTo(map);
      });
    }

    function atualizarTabela(cargas) {
      const tbody = document.getElementById("tabelaCargas");
      tbody.innerHTML = "";
      cargas.forEach(carga => {
        const row = `
          <tr>
            <td class="px-4 py-2">${carga.origem.cidade}</td>
            <td class="px-4 py-2">${carga.destino.cidade}</td>
            <td class="px-4 py-2">${carga.tipoCaminhao}</td>
            <td class="px-4 py-2">${carga.peso} ton</td>
            <td class="px-4 py-2">${carga.dataCarregamento}</td>
            <td class="px-4 py-2">${carga.pagamento}</td>
            <td class="px-4 py-2">
              <button onclick="fazerProposta(${carga.id})" class="bg-blue-500 text-white px-2 py-1 rounded">Propor</button>
            </td>
          </tr>
        `;
        tbody.insertAdjacentHTML("beforeend", row);
      });
    }

    // === Publicar nova carga ===
    document.getElementById("formCarga").addEventListener("submit", async (e) => {
      e.preventDefault();
      const dados = {
        origem: document.getElementById("origem").value,
        destino: document.getElementById("destino").value,
        tipoCaminhao: document.getElementById("tipoCaminhao").value,
        peso: document.getElementById("peso").value,
        dataCarregamento: document.getElementById("dataCarregamento").value,
        pagamento: document.getElementById("pagamento").value
      };

      const response = await fetch("https://suaapi.com/cargas", {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify(dados)
      });

      if (response.ok) {
        alert("Carga publicada!");
        carregarCargas();
      } else {
        alert("Erro ao publicar carga.");
      }
    });

    // === Fazer proposta ===
    async function fazerProposta(cargaId) {
      const valor = prompt("Digite o valor da proposta (€):");
      if (!valor) return;

      const response = await fetch(`https://suaapi.com/cargas/${cargaId}/propostas`, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ valor })
      });

      if (response.ok) {
        alert("Proposta enviada!");
      } else {
        alert("Erro ao enviar proposta.");
      }
    }

    // Carregar ao abrir
    carregarCargas();
  </script>
</body>
</html>
